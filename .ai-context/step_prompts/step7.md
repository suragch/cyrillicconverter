

**Goal:** Configure the SvelteKit application to be a Progressive Web App (PWA) by creating a web app manifest and a service worker, enabling offline functionality and application caching.

**Context:**
*   You have a basic SvelteKit frontend in `frontend/`.
*   SvelteKit has built-in support for service workers.

**Instructions for Gemini CLI Agent:**

Steps 1 and two are already finished. Continue with step 3.

1.  **Create PWA Icons:**
    *   Create a new directory for PWA icons: `frontend/static/icons`
    *   Generate two placeholder PNG image files. These are necessary for the `manifest.json` to be valid.
        *   `frontend/static/icons/icon-192x192.png` 

2.  **Create `frontend/static/manifest.json`:**
    *   Create the web app manifest file. This JSON file tells the browser about your PWA and how it should behave when installed on a user's device.

        ```json
        {
          "name": "Cyrillic-Traditional Mongolian Converter",
          "short_name": "MN Converter",
          "description": "A privacy-first web app that converts Cyrillic Mongolian text to Traditional Mongolian script instantly in your browser.",
          "start_url": "/",
          "display": "standalone",
          "background_color": "#ffffff",
          "theme_color": "#0052FF",
          "icons": [
            {
              "src": "/icons/icon-192x192.png",
              "sizes": "192x192",
              "type": "image/png"
            },
            {
              "src": "/icons/icon-512x512.png",
              "sizes": "512x512",
              "type": "image/png"
            },
            {
              "src": "/icons/icon-512x512.png",
              "sizes": "512x512",
              "type": "image/png",
              "purpose": "maskable"
            }
          ]
        }
        ```

3.  **Edit `frontend/src/app.html`:**
    *   Add the necessary `<link>` tag to reference your `manifest.json` and a `<meta>` tag for `theme-color` within the `<head>` section of your `app.html` file.

        ```html
        <!doctype html>
        <html lang="en">
          <head>
            <meta charset="utf-8" />
            <link rel="icon" href="%sveltekit.assets%/favicon.png" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <link rel="manifest" href="/manifest.json" /> <!-- Link to your manifest -->
            <meta name="theme-color" content="#0052FF" /> <!-- Matches theme_color in manifest -->
            %sveltekit.head%
          </head>
          <body data-sveltekit-preload-data="hover">
            <div style="display: contents">%sveltekit.body%</div>
          </body>
        </html>
        ```

4.  **Create `frontend/src/service-worker.ts`:**
    *   Create the service worker file. This script will handle caching of application assets (the "app shell") and network requests, enabling offline access. SvelteKit's `$service-worker` module simplifies caching build and static files.

        ```typescript
        /// <reference types="@sveltejs/kit" />
        /// <reference no-default-lib="true"/>
        /// <reference lib="esnext" />
        /// <reference lib="webworker" />

        import { build, files, version } from '$service-worker';

        // Define a unique cache name for this version of the app
        const CACHE_NAME = `static-cache-${version}`;

        // Assets to eagerly cache on install (app shell)
        const assetsToCache = [
            ...build, // Files generated by SvelteKit build process (e.g., JS, CSS)
            ...files,  // Files in the 'static' directory (e.g., icons, manifest)
            '/',       // Cache the root route
            '/index.html' // Also cache index.html explicitly
        ];

        // --- Install Event ---
        // Fired when the service worker is installed. Caches all essential app assets.
        self.addEventListener('install', (event) => {
            event.waitUntil(
                caches.open(CACHE_NAME).then((cache) => {
                    console.log(`[Service Worker] Caching app shell (v${version})...`);
                    return cache.addAll(assetsToCache).catch((error) => {
                        console.error('[Service Worker] Failed to cache some assets:', error);
                    });
                })
            );
        });

        // --- Activate Event ---
        // Fired when the service worker is activated. Cleans up old caches.
        self.addEventListener('activate', (event) => {
            event.waitUntil(
                caches.keys().then(async (keys) => {
                    // Delete old caches that don't match the current CACHE_NAME
                    for (const key of keys) {
                        if (key !== CACHE_NAME) {
                            console.log(`[Service Worker] Deleting old cache: ${key}`);
                            await caches.delete(key);
                        }
                    }
                    // Take control of all pages within the scope
                    self.clients.claim();
                    console.log(`[Service Worker] Activated (v${version}).`);
                })
            );
        });

        // --- Fetch Event ---
        // Fired for every network request. Implements a "cache-first, then network" strategy.
        self.addEventListener('fetch', (event) => {
            // Only handle GET requests
            if (event.request.method !== 'GET') return;

            event.respondWith(
                caches.match(event.request).then((cachedResponse) => {
                    // If a cached response exists, return it immediately
                    if (cachedResponse) {
                        return cachedResponse;
                    }

                    // Otherwise, fetch from the network
                    return fetch(event.request).then((networkResponse) => {
                        // Cache successful, non-opaque, HTTP/HTTPS responses
                        // Prevents caching of e.g. cross-origin requests that might be redirects
                        if (networkResponse.ok && networkResponse.type === 'basic' && networkResponse.url.startsWith('http')) {
                            const responseToCache = networkResponse.clone(); // Clone response as it can only be consumed once
                            caches.open(CACHE_NAME).then((cache) => {
                                cache.put(event.request, responseToCache);
                            });
                        }
                        return networkResponse;
                    }).catch((error) => {
                        // Network request failed, and no cache match.
                        console.error('[Service Worker] Fetch failed and no cache match for:', event.request.url, error);
                        // You could serve a generic offline page here if one exists
                        // e.g., return caches.match('/offline.html');
                        throw error; // Propagate the error
                    });
                })
            );
        });

        // --- Background Sync Event (Placeholder) ---
        // This event listener will be used in a later step (Step 14) for offline data submission.
        self.addEventListener('sync', (event) => {
            if (event.tag === 'new-contribution-sync') {
                console.log('[Service Worker] Background sync triggered for new contributions!');
                // Placeholder: In Step 14, logic to send queued contributions to the backend will go here.
                // event.waitUntil(syncNewContributions());
            }
        });
        ```

5.  **Save All Changes:**
    *   Ensure all created/modified files (`frontend/static/icons/icon-192x192.png`, `frontend/static/icons/icon-512x512.png`, `frontend/static/manifest.json`, `frontend/src/app.html`, `frontend/src/service-worker.ts`) are saved.

6.  **Verify Implementation (User Instructions):**
    *   **Build the App:** It's crucial to build the SvelteKit application for the service worker to be properly generated and registered.
        *   Navigate to the `frontend` directory: `cd frontend`
        *   Run the build command: `npm run build`
    *   **Preview the App:** Serve the built application using SvelteKit's preview command. This simulates a production environment.
        *   Run: `npm run preview`
    *   **Open Developer Tools:** Open your browser's developer tools (usually F12 or Ctrl+Shift+I).
    *   **Application Tab:** Go to the "Application" tab.
        *   **Manifest:** Under "Manifest," you should see the `manifest.json` loaded with details like the app name, short name, and icons.
        *   **Service Workers:** Under "Service Workers," you should see your `service-worker.ts` registered and activated.
        *   **Cache Storage:** Under "Cache Storage," expand "Cache Storage." You should see `static-cache-<version_number>` containing your application's static assets (HTML, CSS, JS, manifest, icons).
    *   **Test Offline Functionality:**
        1.  While the app is running and inspected in dev tools, go to the "Network" tab.
        2.  Check the "Offline" checkbox (or set throttling to "Offline").
        3.  Refresh the page (`Ctrl+R` or `Cmd+R`).
        4.  The application should still load and display correctly, served from the service worker cache. In the network tab, resources should show "ServiceWorker" as their source.
        5.  Uncheck "Offline" to resume normal network behavior.

